//
//  OutputFolder.swift
//  ModelHike
//  https://www.github.com/modelhike/modelhike
//

import Foundation

public protocol PersistableFolder : AnyObject, CustomDebugStringConvertible {
    var foldername: String { get }
    var newFoldername: String { get }
    var outputFolder: OutputFolder? { get set }
    func persist() throws
}

public class OutputFolder : CustomDebugStringConvertible {
    internal private(set) var folder: LocalFolder
    public var subFolders: [OutputFolder] = []
    public private(set) var items: [OutputFile] = []
    public private(set) var folderItems: [PersistableFolder] = []
    public var autoGeneratedFileNumber: Int = 1

    public var foldername: String { folder.name }
    public var path: LocalPath { folder.path }

    public func add(_ file: OutputFile) {
        file.outputPath = self.folder.path
        items.append(file)
    }

    public func add(_ subFolder: PersistableFolder) {
        subFolder.outputFolder = OutputFolder(self.folder / subFolder.newFoldername)
        self.folderItems.append(subFolder)
    }

    public func add(_ subFolder: OutputFolder) {
        self.subFolders.append(subFolder)
    }

    public func add(_ doc: Document) {
        let filename = "file\(autoGeneratedFileNumber)"
        autoGeneratedFileNumber += 1
        add(doc, filename: filename)
    }

    public func add(_ doc: Document, filename: String) {
        let docFile = OutputDocumentFile(doc, filename: filename)
        docFile.outputPath = self.folder.path
        items.append(docFile)
    }

    public func add(_ doc: Document, to fileSetName: String) {
        let folder = subFolder(fileSetName)
        folder.add(doc)
    }

    public func add(_ doc: Document, filename: String, to fileSetName: String) {
        let folder = subFolder(fileSetName)
        folder.add(doc, filename: filename)
    }

    public func persist(with context: GenerationContext) throws {
        guard items.count > 0 || folderItems.count > 0 || subFolders.count > 0 else {
            return
        }
        
        //create the folder only if any file or sub folder is persisted
        try self.ensureExists()

        for folder in subFolders {
            try folder.persist(with: context)
            context.addGenerated(folderPath: folder.path)
        }

        for folder in folderItems {
            if let outputFolder = folder.outputFolder {
                try folder.persist()
                context.addGenerated(folderPath: outputFolder.folder)
            }
        }

        for item in items {
            if let outputPath = item.outputPath {
                try item.persist()
                context.addGenerated(filePath: outputPath.string + item.filename)
            }
        }
    }

    @discardableResult
    public func ensureExists() throws -> Self {
        try self.folder.ensureExists()
        return self
    }

    public func clearFiles() throws {
        try folder.deleteAllFilesAndFolders()
    }

    public lazy var content: OutputFolder = { subFolder("content") }()
    public lazy var pages: OutputFolder = { subFolder("pages") }()
    public lazy var templates: OutputFolder = { subFolder("templates") }()
    public lazy var assets: OutputFolder = { subFolder("assets") }()

    public func relativeFolder(_ itemName: String) -> OutputFolder {
        //if existing return that sub folder
        for folder in self.subFolders {
            let lastPath = String(folder.folder.url.relativePath.suffix(itemName.count))
            if lastPath.is(itemName) {
                return folder
            }
        }

        //else, create a new sub folder, with the relative path
        return createNewRelativeSubFolder(relativePath: itemName)
    }
    
    private func createNewRelativeSubFolder(relativePath: String) -> OutputFolder {
        let folder = LocalFolder(relativePath: relativePath, basePath: self.folder)
        let newSubFolder = OutputFolder(folder)
        self.subFolders.append(newSubFolder)
        return newSubFolder
    }
    
    public func subFolder(_ itemName: String) -> OutputFolder {
        //if existing return that sub folder
        for folder in self.subFolders {
            if folder.folder.name.is(itemName) {
                return folder
            }
        }

        //else, create a new sub folder
        return createNewSubFolder(name: itemName)
    }

    private func createNewSubFolder(name: String) -> OutputFolder {
        let newSubFolder = OutputFolder(folder.subfolder(at: name))
        self.subFolders.append(newSubFolder)
        return newSubFolder
    }

    public var debugDescription: String {
        return folder.pathString
    }
    
    public init(_ name: String) {
        self.folder = LocalFolder(path: name)
    }

    public init(_ path: LocalPath) {
        self.folder = LocalFolder(path: path)
    }

    public init(_ folder: LocalFolder) {
        self.folder = folder
    }
}
