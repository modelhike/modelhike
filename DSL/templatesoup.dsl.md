# TemplateSoup + SoupyScript — Syntax Reference

> **Single source of truth for template and scripting syntax.**
> Update this file when any syntax changes. Do not duplicate these tables in `AGENTS.md`.

---

## 1 · TemplateSoup — `.teso` template files

**Purpose:** Text-first. The file IS the output — the TypeScript, Java, YAML, etc. that will be written to disk — with script lines embedded as the exception. Script lines (`:`) exist purely for logic and control: looping over entities, branching on conditions, setting variables. They produce no output themselves.

**Parser:** `TemplateSoupParser` (`isStatementsPrefixedWithKeyword: true`)

| Line type | How to write it | Behaviour |
| --------- | --------------- | --------- |
| **Output text** (default) | write the line as-is | Written directly to the generated file; `{{ expr }}` evaluated inline |
| **Statement** | prefix with `:` | Executed as a SoupyScript command; nothing written to output |
| **Blank output line** | `:` alone | Emits an empty line in the generated file |

```teso
: for entity in module.entities
import { {{ entity.name }}Service } from './{{ entity.name | lowercase + kebabcase }}.service';

export class {{ entity.name }}Controller {
  constructor(private readonly service: {{ entity.name }}Service) {}
}
:
: end-for
```

> All lines without `:` go to the generated file verbatim (after evaluating any `{{ }}`). A line that starts with `:` but has no recognised keyword is still treated as a statement and silently discarded.

---

## 2 · SoupyScript — `.ss` script files

**Purpose:** Script-first. The file IS the orchestration logic — setting variables, looping, deciding which templates to render. Statements are the default; every line is executed as a command.

**Parser:** `SoupyScriptParser` (`isStatementsPrefixedWithKeyword: false`)

| Line type | How to write it | Behaviour |
| --------- | --------------- | --------- |
| **Statement** (default) | write the line as-is | Executed as a SoupyScript command |
| **Multi-line string content** | prefix with `>` | Used **inside `set-str` blocks only** — each `>` line contributes to the captured string; `{{ expr }}` evaluated inline |
| **Blank line in captured string** | `>` alone | Emits an empty line inside the `set-str` capture |

The `>` prefix is **not** for console or file output. For display use `announce` (user-visible) or `console-log` (debug). File content comes from rendering `.teso` templates via `render-file`.

```ss
for module in @container.modules
  set module_folder_name = module.name | lowercase + kebabcase
  set working_dir = "apps/" + module_folder_name + "/src"
  for entity in module.entities
    set apis = entity | apis
    announce "Generating {{ entity.name }}"
    render-file "entity.controller" as "controller.ts"
  end-for
end-for

// > used correctly — inside set-str to build a multi-line string value
set-str header
> // generated by ModelHike
> // entity: {{ entity.name }}
>
end-set
```

> `//` comment lines are skipped by both parsers. Visual separators (`---`, `***`) at the start of a statement line are also silently ignored.

### Front matter (`.ss` only)

`.ss` files may open with a front matter block — any line of only `-` characters acts as the delimiter. Key-value pairs inside use `:`.

```
-----
Product-name : GenProduct
Company-name : WowCompany
api-base-path : /api/v1
-----
```

These values become template variables available throughout the render.

---

## 3 · Common syntax (shared by both file types)

### Print expressions — `{{ }}`

Appear inside **output text lines** (non-`:` in `.teso`, `>` in `.ss`):

| Syntax | What it does |
| ------ | ------------ |
| `{{ varname }}` | Print a variable |
| `{{ obj.propname }}` | Access an object property |
| `{{ varname \| modifier }}` | Apply a modifier |
| `{{ varname \| mod1 + mod2 }}` | Chain modifiers (left to right) |
| `{{ (cond1 and cond2) or cond3 }}` | Boolean expression |

**Inline function call** — returns a rendered value into output text; note the `=` delimiters, not `{`:

```
={{ call fnName(param : value) }}=
```

### Modifiers

Applied with `|` in expressions or `set` statements:

```
set folder = entity.name | lowercase + kebabcase
{{ module.port | round }}
```

Chain with `+`: `mod1 + mod2` applies left to right.

### Built-in variables (`@varname`)

Variables injected by the engine start with `@`. See §5 for the full reference.

### Block end keywords

Every block-opening statement has a closing form. Both hyphenated and non-hyphenated are accepted:

| Open | Close (preferred) | Close (alternate) |
| ---- | ----------------- | ----------------- |
| `for` | `end-for` | `endfor` |
| `if` | `end-if` | `endif` |
| `func` | `end-func` | `endfunc` |
| `set-str` | `end-set` | `endset` |
| `spaceless` | `end-spaceless` | `endspaceless` |

### Comments

`//` at the start of a line is recognised as an explicit comment and skipped by both parsers. Unrecognised statement lines in `.ss` are flagged as `UnIdentifiedStmt` (not silently dropped).

---

## 4 · Statement Reference

All statements below work in both file types; only the prefix changes.

| Statement      | `.ss` syntax                                     | `.teso` syntax                                       | Description |
| -------------- | ------------------------------------------------ | ---------------------------------------------------- | ----------- |
| `for`          | `for item in collection`                         | `: for item in collection`                           | Loop over an array |
| `end-for`      | `end-for`                                        | `: end-for`                                          | End for loop |
| `if`           | `if condition`                                   | `: if condition`                                     | Conditional |
| `else-if`      | `else-if condition`                              | `: else-if condition`                                | Else-if branch |
| `else`         | `else`                                           | `: else`                                             | Else branch |
| `end-if`       | `end-if`                                         | `: end-if`                                           | End conditional |
| `set`          | `set varname = expr \| mod1 + mod2`               | `: set varname = expr \| mod1`                        | Assign variable with optional modifiers |
| `set-str`      | `set-str varname` → `> content lines` → `end-set`  | `: set-str varname` → `> content lines` → `: end-set`  | Capture multi-line rendered string into a variable; content lines use `>` prefix in **both** file types |
| `func`         | `func fnName(param1, param2)`                    | `: func fnName(param1, param2)`                      | Define a reusable template function |
| `end-func`     | `end-func`                                       | `: end-func`                                         | End function definition |
| `call`         | `call fnName(p1 : val1, p2 : val2)`              | `: call fnName(p1 : val1)`                           | Invoke a template function |
| `render-file`  | `render-file "templateName"`                     | `: render-file "templateName"`                       | Render a `.teso` template; output file named after the template |
| `render-file as` | `render-file "templateName" as "filename"`     | `: render-file "templateName" as "filename"`         | Render template to a specific output filename |
| `render-folder` | `render-folder "folderName" to "outputPath"`    | `: render-folder "folderName" to "outputPath"`       | Render all templates in a blueprint subfolder |
| `copy-folder`  | `copy-folder "folderName"`                       | `: copy-folder "folderName"`                         | Copy a static blueprint folder as-is |
| `spaceless`    | `spaceless`                                      | `: spaceless`                                        | Begin whitespace-stripping block |
| `end-spaceless` | `end-spaceless`                                 | `: end-spaceless`                                    | End whitespace-stripping block |
| `announce`     | `announce "message"`                             | `: announce "message"`                               | Print visible progress message to console |
| `console-log`  | `console-log "message"`                          | `: console-log "message"`                            | Debug print to stdout (evaluates expressions, not just strings) |
| `fatal-error`  | `fatal-error message`                            | `: fatal-error message`                              | Abort with error |
| `stop`         | `stop`                                           | `: stop`                                             | Stop rendering the current file |
| `run-shell-cmd` | `run-shell-cmd "command"`                       | `: run-shell-cmd "command"`                          | Execute a shell command |

**Block end keywords:** both `end-keyword` (hyphenated) and `endkeyword` (no hyphen) forms are accepted.

---

## 5 · Built-in Template Variables

### 5.1 Top-level (injected by `CodeGenerationSandbox`)

| Variable               | Type              | Description                                      |
| ---------------------- | ----------------- | ------------------------------------------------ |
| `@container`           | `C4Container_Wrap` | The container being generated                   |
| `@container.modules`   | list              | All modules (C4Components) in the container      |
| `@container.commons`   | list              | Common model modules (from `common.modelhike`)   |
| `@mock`                | `Mocking_Wrap`    | Mock data helpers                                |
| `@mock.object-id`      | String            | A generated mock ObjectId                        |
| `@loop`                | `ForLoop_Wrap`    | Active inside `for` loops                        |
| `@loop.FIRST_IN_LOOP`  | Bool              | True on the first iteration                      |
| `@loop.LAST_IN_LOOP`   | Bool              | True on the last iteration                       |

### 5.2 Module-level (`for module in @container.modules`)

| Variable                   | Description                                               |
| -------------------------- | --------------------------------------------------------- |
| `module.name`              | Normalised module name                                    |
| `module.given-name`        | Original human-readable name                              |
| `module.port`              | Assigned port number (sequential from 3001, set in Hydrate phase) |
| `module.types`             | All types in the module (entities + DTOs + embedded)      |
| `module.entities`          | Entity types only (`dataType == .entity`)                 |
| `module.entities-and-dtos` | Entities and DTOs combined                                |
| `module.embedded-types`    | Embedded value types (no `id` field)                      |
| `module.has-mutation-apis` | Bool — module has any create/update/delete APIs           |
| `module.has-query-apis`    | Bool — module has any read APIs                           |
| `module.has-push-apis`     | Bool — module has any push/subscription APIs              |
| `module.mutation-apis`     | List of mutation APIs across the module                   |
| `module.query-apis`        | List of query APIs across the module                      |
| `module.push-apis`         | List of push APIs across the module                       |

### 5.3 Entity/Type-level (`for entity in module.entities`)

| Variable              | Description                                                     |
| --------------------- | --------------------------------------------------------------- |
| `entity.name`         | Normalised entity name (camelCase)                              |
| `entity.given-name`   | Original name with spaces                                       |
| `entity.folder_name`  | Set by script: `entity.given-name \| lowercase + kebabcase`      |
| `entity.properties`   | List of properties                                              |
| `entity.has-any-apis` | Bool                                                            |
| `entity.has-push-apis` | Bool                                                           |
| `entity \| apis`       | Returns `APIList` for this entity (via `ModelLib.apis` modifier) |
| `type.name`           | Same as `entity.name` (when iterating `module.types`)           |
| `type.properties`     | Same as `entity.properties`                                     |

### 5.4 Property-level (`for property in entity.properties`)

| Variable                     | Description                                          |
| ---------------------------- | ---------------------------------------------------- |
| `property.name`              | Normalised property name                             |
| `property.is-required`       | Bool                                                 |
| `property.is-array`          | Bool                                                 |
| `property.is-number`         | Bool (int / double / float)                          |
| `property.is-bool`           | Bool                                                 |
| `property.is-date`           | Bool (date or datetime)                              |
| `property.is-buffer`         | Bool                                                 |
| `property.is-any`            | Bool                                                 |
| `property.is-string`         | Bool                                                 |
| `property.is-id`             | Bool                                                 |
| `property.is-reference`      | Bool                                                 |
| `property.is-extended-reference` | Bool                                             |
| `property.is-coded-value`    | Bool                                                 |
| `property.is-custom-type`    | Bool                                                 |
| `property.is-object`         | Bool (reference / codedValue / customType)           |
| `property.custom-type`       | String — the custom type name                        |
| `property.obj-type`          | String — object type string                          |
| `property.has-attrib-oneOf`  | Bool — has a `oneOf` validation attribute            |
| `property.attrib-oneOf`      | String — the oneOf values                            |
| `property \| typename`        | TypeScript/Java type string (via `TypescriptLib`/`JavaLib`) |
| `property \| graphql-typename` | GraphQL type string                                 |
| `property \| default-value`   | Default value string                                 |

### 5.5 API-level (`set apis = entity | apis` then `for api in apis`)

| Variable                       | Description                                              |
| ------------------------------ | -------------------------------------------------------- |
| `api.name`                     | API operation name                                       |
| `api.givenname`                | Original name                                            |
| `api.type`                     | `APIType` enum value as string                           |
| `api.path`                     | Route path suffix (e.g. `:id`)                           |
| `api.has-path`                 | Bool — path is non-empty                                 |
| `api.is-create`                | Bool                                                     |
| `api.is-update`                | Bool                                                     |
| `api.is-delete`                | Bool                                                     |
| `api.is-get-by-id`             | Bool                                                     |
| `api.is-list`                  | Bool                                                     |
| `api.is-list-by-custom-props`  | Bool                                                     |
| `api.is-list-by-custom-logic`  | Bool                                                     |
| `api.is-mutation-by-custom-logic` | Bool                                                  |
| `api.is-get-by-custom-logic`   | Bool                                                     |
| `api.is-push-data`             | Bool                                                     |
| `api.is-push-datalist`         | Bool                                                     |
| `api.cqrs-classname`           | **Writable** — set by script (e.g. `"Create{Entity}Command"`) |
| `api.cqrs-file-import-path`    | **Writable** — set by script (e.g. `"./crud/create.{entity}"`) |
| `api.cqrs-handler-name`        | CQRS handler class name                                  |
| `api.query-params`             | List of query parameters (for list-by APIs)              |
| `api.properties-involved`      | Properties used by this API                              |
| `api.custom-params`            | Custom parameters                                        |
| `api.return-type`              | Return type info                                         |
| `api.input-type`               | Input type info                                          |
| `api.entity`                   | The entity this API belongs to                           |

### 5.6 Query parameter-level (`for param in api.query-params`)

| Variable                    | Description                                        |
| --------------------------- | -------------------------------------------------- |
| `param.param-name`          | Query parameter name                               |
| `param.second-param-name`   | Secondary param name (if mapped)                   |
| `param.has-second-param-name` | Bool                                             |
| `param.has-multiple-params` | Bool — multi-value param (uses `...` suffix in model) |
| `param.prop-mapping-first`  | Property path the param maps to                    |

### 5.7 Script-local variables (set by `main.ss`)

These are not injected by the engine — scripts set them with `set`:

| Variable                  | Description                                                     |
| ------------------------- | --------------------------------------------------------------- |
| `working_dir`             | Output subdirectory path; controls where rendered files land    |
| `module_folder_name`      | `module.name \| lowercase + kebabcase`                           |
| `module_pkg_name`         | Java package name for the module                                |
| `module_folder_structure` | Java folder path derived from package name                      |
| `entity_pkg_name`         | Java package name for the entity                                |
| `submodule_folder_name`   | `entity.given-name \| lowercase + kebabcase`                     |
| `apis`                    | Result of `entity \| apis`                                       |
| `file_name`               | Current output filename (set per `render-file` call)            |
| `classname`               | CQRS class name being generated                                 |
| `Product-name`            | From front matter — used in generated README/package.json       |
| `Company-name`            | From front matter                                               |
| `api-base-path`           | From front matter (Spring Boot) — e.g. `/api/v1`               |
| `company-pkg-prefix`      | Java company package prefix                                     |

---

## 6 · Modifiers

Applied with `{{ value | modifier }}` or chained `{{ value | mod1 + mod2 }}`.

### 6.1 Default string modifiers (`DefaultModifiersLibrary`)

| Modifier              | Description                         |
| --------------------- | ----------------------------------- |
| `length`              | Character count                     |
| `capitalise`          | Capitalise first letter             |
| `lowercase`           | All lowercase                       |
| `uppercase`           | All uppercase                       |
| `lowerFirst`          | First letter lowercase              |
| `upperFirst`          | First letter uppercase              |
| `trim`                | Strip leading/trailing whitespace   |
| `replace(from, to)`   | String substitution                 |
| `urlEncode`           | URL-encode the string               |
| `urlDecode`           | URL-decode the string               |
| `nl2br`               | Replace newlines with `<br>`        |

### 6.2 Default math modifiers (`DefaultModifiersLibrary`)

| Modifier | Description  |
| -------- | ------------ |
| `abs`    | Absolute value |
| `min`    | Minimum      |
| `max`    | Maximum      |
| `sum`    | Sum          |
| `sqrt`   | Square root  |
| `round`  | Round        |
| `avg`    | Average      |

### 6.3 Default array modifiers (`DefaultModifiersLibrary`)

| Modifier           | Description                   |
| ------------------ | ----------------------------- |
| `count`            | Number of elements            |
| `sort`             | Sort ascending                |
| `reverse`          | Reverse order                 |
| `first`            | First element                 |
| `last`             | Last element                  |
| `join(separator)`  | Join to string                |
| `sum` / `avg` / `min` / `max` | Aggregate numeric values |

### 6.4 Default dictionary modifiers (`DefaultModifiersLibrary`)

| Modifier | Description           |
| -------- | --------------------- |
| `count`  | Number of entries     |
| `keys`   | List of keys          |
| `values` | List of values        |

### 6.5 Date modifiers (`DefaultModifiersLibrary`)

| Modifier                | Description                       |
| ----------------------- | --------------------------------- |
| `Date(y, m, d, ...)`    | Construct a date value            |
| `format(formatString)`  | Format a date with a format string |

### 6.6 Generation / naming modifiers (`GenerationLib`)

| Modifier                   | Description                                              |
| -------------------------- | -------------------------------------------------------- |
| `kebabcase`                | Convert to kebab-case (`"FlightView"` → `"flight-view"`) |
| `split-camel-to-kebabcase` | Split camelCase to kebab-case (for URLs / collection names) |
| `plural`                   | Pluralise (`"Flight"` → `"Flights"`)                    |
| `package-case`             | Convert for Java package names                           |
| `filter-string`            | Generate a filter query string                           |

Common chains: `lowercase + kebabcase`, `lowercase + plural`, `package-case + lowercase`.

### 6.7 Model introspection modifiers (`ModelLib`)

| Modifier                             | Description                                                          |
| ------------------------------------ | -------------------------------------------------------------------- |
| `apis`                               | `entity \| apis` — returns `APIList` for an entity                    |
| `get-last-recursive-prop(entity.name)` | Resolves a dot-path property reference against a named entity      |
| `get-object`                         | Dereferences a property to its type object                           |

### 6.8 Language-specific type modifiers

| Modifier              | Library               | Description                                           |
| --------------------- | --------------------- | ----------------------------------------------------- |
| `typename`            | `TypescriptLib`       | Maps `PropertyKind` to TypeScript type string         |
| `default-value`       | `TypescriptLib`       | Maps `PropertyKind` to TS default value string        |
| `typename`            | `JavaLib`             | Maps `PropertyKind` to Java type string               |
| `default-value`       | `JavaLib`             | Maps `PropertyKind` to Java default value string      |
| `graphql-typename`    | `GraphQLLib`          | Maps `PropertyKind` to GraphQL type string            |

> Which library is active depends on which symbols are loaded. NestJS blueprints load `.typescript` + `.mongodb_typescript`; Spring Boot loads `.java`. Both always include `GraphQLLib`.

### 6.9 Mock data modifiers (`MockDataLib`)

| Modifier        | Description                                  |
| --------------- | -------------------------------------------- |
| `sample-json`   | Generate sample JSON string for an entity    |
| `sample-query`  | Generate sample query string                 |
| `sample-value`  | Generate a sample value for a property type  |

---

## 7 · Operators

Infix operators used in conditions and expressions:

| Operator | Type        | Example                       |
| -------- | ----------- | ----------------------------- |
| `and`    | logical     | `if condA and condB`          |
| `or`     | logical     | `if condA or condB`           |
| `not`    | logical     | `if not condA`                |
| `==`     | equality    | `if entity.name == "Order"`   |
| `!=`     | inequality  | `if property.is-id != true`   |
| `<` `>` `<=` `>=` | comparison | `if module.port >= 3001` |
| `+` `-` `*` `/` | arithmetic | `set total = count + 1` |

Parentheses group sub-expressions: `if (condA and condB) or condC`.

---

## 8 · Quick-reference cheatsheet

### `.ss` script — statements are the default, `>` marks output text

```
// Statements have no prefix
for module in @container.modules
  set module_folder_name = module.name | lowercase + kebabcase
  set working_dir = "apps/" + module_folder_name + "/src"
  for entity in module.entities
    set apis = entity | apis
    // Emit a small snippet of literal output using >
    > Processing {{ entity.name }}...
    render-file "entity.controller" as "controller.ts"
  end-for
end-for

// set-str captures multi-line output text; > prefix required on content lines
set-str myBlock
> export class {{ entity.name }}Controller {
>   // generated
> }
end-set
```

### `.teso` template — output text is the default, `:` marks script lines

```
: for module in @container.modules
:   set working_dir = "apps/{{ module.name | lowercase + kebabcase }}/src"
:   for entity in module.entities
// Everything without : is written directly to the generated file:
import { {{ entity.name }}Service } from './{{ entity.name | lowercase + kebabcase }}.service';

export class {{ entity.name }}Controller {
  constructor(private readonly service: {{ entity.name }}Service) {}
}
:
:   end-for
: end-for
```

> **Key rule:** In `.ss`, ask "is this a command or output?" — output needs `>`. In `.teso`, ask the same — commands need `:`. Everything else goes to the generated file.
